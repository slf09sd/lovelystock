<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LovelyStock — Spread the Love</title>
  <style>
    /* 
      --- V6: The Maestro Update ---
      - NEW: Liquid Search Bar animation on focus.
      - NEW: Popup "emerges" from clicked card using FLIP animation.
      - NEW: Popup features "MacBook" style window controls (close, expand).
      - NEW: Fullscreen image view within the popup.
      - REFINED: Custom scrollbar for long descriptions in the popup.
      - FIXED: More robust default scrollbar hiding.
      - FIXED: Filename sanitization for downloads is perfected.
    */
    :root{
      --bg-grad: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --text: #000;
      --text-muted: #4a5263; 
      --accent: #ef476f;
      --radius: 16px;
      --shadow-lg: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
      --glass: rgba(255, 255, 255, 0.5);
      --glass-border: rgba(255, 255, 255, 0.2);
      --gap: 16px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      color-scheme: light;
    }

    .dark-mode {
      --bg-grad: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --glass: rgba(31, 41, 55, 0.45);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg-grad);color:var(--text);transition:background .3s ease}
    
    html{scrollbar-width:none} /* Firefox */
    html::-webkit-scrollbar{display:none} /* Chrome, Safari, Opera */

    .custom-scrollbar{position:fixed;top:0;right:4px;height:100%;width:10px;z-index:1000;pointer-events:none}
    .custom-scrollbar-thumb{position:absolute;right:2px;width:6px;background:var(--accent);border-radius:3px;opacity:0;transition:opacity .3s ease, background .3s ease;pointer-events:auto}
    .is-scrolling .custom-scrollbar-thumb{opacity:0.7}

    /* --- Liquid Search Header --- */
    header{
      position:fixed; top:16px; left:16px; right:16px; max-width:980px; margin: 0 auto;
      display:flex;align-items:center;padding:10px 12px; gap:12px;
      background:var(--glass); backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px);
      border:1px solid var(--glass-border); border-radius:999px; box-shadow:var(--shadow-lg);
      z-index:40; transition:all .4s cubic-bezier(0.45, 0.05, 0.55, 0.95);
    }
    .logo{font-weight:700;font-size:20px;color:var(--accent);cursor:pointer;white-space:nowrap;transition:width .4s cubic-bezier(0.45, 0.05, 0.55, 0.95), opacity .4s ease; overflow:hidden;}
    .logo-text{display:inline-block;}
    .search-bar{display:flex;flex:1;gap:8px;align-items:center;transition:all .4s cubic-bezier(0.45, 0.05, 0.55, 0.95)}
    .header-actions{transition:opacity .4s ease, transform .4s ease}

    header.search-focused{gap:0; padding-left: 20px; padding-right: 20px;}
    header.search-focused .logo{width:35px;}
    header.search-focused .header-actions{opacity:0; transform:translateX(20px); pointer-events:none;}

    main{padding:100px var(--gap) 20px;max-width:1600px;margin:0 auto}
    #imageGallery{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:var(--gap);transition:opacity .4s ease; min-height:50vh}
    #imageGallery.loading{opacity:0.5}

    .loader-container{display:none;justify-content:center;align-items:center;padding:80px;grid-column:1/-1}
    .loader{width:48px;height:48px;border:5px solid;border-color:var(--accent) transparent;border-radius:50%;display:inline-block;animation:rotation 1s linear infinite}
    @keyframes rotation{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    .image-card{visibility:hidden; /* Hide until revealed by JS */}
    .image-card.loaded{visibility:visible;opacity:0;transform:translateY(10px);animation:cardIn .42s forwards;}
    @keyframes cardIn{to{opacity:1;transform:none}}
    .image-card a{position:relative;display:block;aspect-ratio:4/3;box-shadow:var(--shadow);padding:1px;background:var(--glass);z-index:1;border-radius:var(--radius);overflow:hidden;transition:transform .28s cubic-bezier(.2,.9,.2,1),box-shadow .25s}
    .image-card a:hover{transform:translateY(-8px) scale(1.03);box-shadow:var(--shadow-lg)}
    .image-card img{width:100%;height:100%;object-fit:cover;display:block;border-radius:calc(var(--radius) - 1px)}

    /* --- Emergent Popup --- */
    .popup{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:200;padding:28px;background:rgba(10,10,20,0.3);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);opacity:0;visibility:hidden;transition:opacity .4s ease, visibility 0s .4s}
    .popup.open{opacity:1;visibility:visible;transition-delay:0s}
    .popup-content{
      max-width:960px;width:100%;background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
      border:1px solid var(--glass-border);border-radius:var(--radius);box-shadow:0 30px 80px rgba(2,6,23,0.35);
      display:flex;gap:18px;align-items:flex-start;padding:12px;
      transition:transform .4s cubic-bezier(0.45, 0.05, 0.55, 0.95), opacity .3s ease, width .4s ease, height .4s ease, max-width .4s ease;
      will-change: transform;
    }
    .popup-media img{width:100%;height:100%;object-fit:contain;background:rgba(0,0,0,0.1);border-radius:10px;max-height:80vh}
    
    .popup-side{display:flex;flex-direction:column;gap:12px;width:320px;flex-shrink:0;transition:opacity .3s ease}
    .popup-title{font-weight:700;font-size:18px;margin:0;padding-right:40px}

    /* Custom scrollbar for description */
    .popup-desc{color:var(--text-muted);font-size:14px;line-height:1.5;overflow-y:auto;max-height:120px;padding-right:8px}
    .popup-desc::-webkit-scrollbar{width:6px}
    .popup-desc::-webkit-scrollbar-track{background:rgba(0,0,0,0.05);border-radius:3px}
    .popup-desc::-webkit-scrollbar-thumb{background:var(--accent);opacity:0.7;border-radius:3px}

    /* MacBook style window controls */
    .window-controls{position:absolute;top:16px;left:16px;display:flex;gap:8px}
    .window-dot{width:12px;height:12px;border-radius:50%;cursor:pointer;background-color:#ddd;opacity:0.6;transition:opacity .2s ease}
    .window-dot:hover{opacity:1}
    .dot-close{background-color:#ff5f57}.dot-min{background-color:#ffbd2e}.dot-expand{background-color:#28c940}
    
    .fullscreen-escape{position:absolute;top:16px;right:16px;opacity:0;visibility:hidden;transition:all .3s ease;z-index:10}
    .popup.fullscreen .fullscreen-escape{opacity:1;visibility:visible}

    /* Fullscreen mode */
    .popup.fullscreen .popup-content{width:100%;height:100%;max-width:100vw;padding:0;border-radius:0}
    .popup.fullscreen .popup-side{opacity:0;pointer-events:none}
    .popup.fullscreen .window-controls{opacity:0;pointer-events:none}
  </style>
</head>
<body>

  <div class="background-container"><div class="blob"></div></div>
  <div class="custom-scrollbar"><div class="custom-scrollbar-thumb"></div></div>

  <header>
    <div class="logo" id="logo"><span class="logo-text">LovelyStock</span></div>
    <div class="search-bar" role="search">
      <input id="searchBox" type="text" placeholder="Search lovely images..." aria-label="Search images">
    </div>
    <div class="header-actions">
      <button id="themeToggle" class="theme-toggle"> <!-- Simplified --> </button>
    </div>
  </header>

  <main>
    <div id="imageGallery"><div class="loader-container"><span class="loader"></span></div></div>
    <div id="pagination"></div>
  </main>

  <div id="imagePopup" class="popup" role="dialog" aria-modal="true">
    <div class="popup-content" role="document">
        <div class="window-controls">
            <span class="window-dot dot-close" aria-label="Close"></span>
            <span class="window-dot dot-min" aria-label="Minimize"></span>
            <span class="window-dot dot-expand" aria-label="Expand"></span>
        </div>
        <button class="fullscreen-escape" aria-label="Exit fullscreen"> <!-- SVG added in JS --> </button>
      <div class="popup-media"><img id="popupImage" src="" alt=""></div>
      <div class="popup-side">
        <h3 id="popupTitle" class="popup-title">Title</h3>
        <div id="popupDesc" class="popup-desc">Description</div>
        <div class="download-actions" style="margin-top:auto;display:flex;gap:10px;align-items:center;padding-top:10px">
          <button id="popupDownload" class="download-button">Download</button>
        </div>
      </div>
    </div>
  </div>

  <footer style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">© 2024 LovelyStock</footer>

  <script>
    // === V6 SCRIPT: THE MAESTRO UPDATE ===

    // --- Dynamic Elements (to avoid querySelector in loops) ---
    const header = document.querySelector('header');
    const logo = document.getElementById('logo');
    const logoText = logo.querySelector('.logo-text');
    const searchBox = document.getElementById('searchBox');
    const gallery = document.getElementById('imageGallery');
    const pagination = document.getElementById('pagination');
    const popup = document.getElementById('imagePopup');
    const popupContent = popup.querySelector('.popup-content');
    const popupImage = document.getElementById('popupImage');
    const popupTitle = document.getElementById('popupTitle');
    const popupDesc = document.getElementById('popupDesc');
    let originRect = null; // For FLIP animation

    // --- Liquid Search Header Logic ---
    function setSearchFocus(isFocused) {
        header.classList.toggle('search-focused', isFocused);
        logoText.textContent = isFocused ? 'LS' : 'LovelyStock';
    }
    searchBox.addEventListener('focus', () => setSearchFocus(true));
    searchBox.addEventListener('blur', () => setSearchFocus(false));
    document.addEventListener('scroll', () => {
        if(header.classList.contains('search-focused') && window.scrollY > 50) {
            searchBox.blur();
        }
    });

    // --- Dark Mode & Theme Toggle Setup ---
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.innerHTML = `<svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg><svg class="icon-sun" style="display:none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
    const iconMoon = themeToggle.querySelector('.icon-moon');
    const iconSun = themeToggle.querySelector('.icon-sun');
    function applyTheme(theme) {
        document.documentElement.classList.toggle('dark-mode', theme === 'dark');
        iconMoon.style.display = theme === 'dark' ? 'none' : 'block';
        iconSun.style.display = theme === 'dark' ? 'block' : 'none';
    }
    let currentTheme = localStorage.getItem('theme') || 'light';
    applyTheme(currentTheme);
    themeToggle.addEventListener('click', () => {
        currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
        localStorage.setItem('theme', currentTheme);
        applyTheme(currentTheme);
    });

    // --- Custom Scrollbar ---
    // (Logic from V5 is unchanged and sufficient)
    const body = document.body;
    let scrollTimeout;
    window.addEventListener('scroll', () => {
        body.classList.add('is-scrolling');
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => body.classList.remove('is-scrolling'), 1500);
        const progress = window.scrollY / (body.scrollHeight - window.innerHeight);
        const thumbHeight = Math.max(30, window.innerHeight * 0.2);
        document.querySelector('.custom-scrollbar-thumb').style.height = `${thumbHeight}px`;
        document.querySelector('.custom-scrollbar-thumb').style.top = `${progress * (window.innerHeight - thumbHeight)}px`;
    });

    // --- CORE GALLERY LOGIC (with preloader) ---
    let images = [], currentPage = 1, currentImageList = [];
    const imagesPerPage = 100;
    const CSV_URL = 'https://slf09sd.github.io/lovelystock/images.csv';

    async function loadCSV() {
        // ... (CSV loading and parsing logic unchanged from V5)
        try{
            const r = await fetch(CSV_URL, {cache:'no-cache'});
            if(!r.ok) throw new Error('CSV fetch failed');
            const text = await r.text();
            if(!text || !text.trim()) throw new Error('CSV empty');
            images = text.split('\n').map(l=>l.trim()).filter(l=>l).slice(1).map(line => {
                const [url, ...titleParts] = line.split(',');
                return { url: url.trim(), title: titleParts.join(',').replace(/"/g, '').trim() };
            }).filter(img => img.url.startsWith('http'));
            showRandomImages();
        } catch(err){
            gallery.innerHTML = '<div class="error-message">Failed to load images.</div>';
        }
    }

    function showRandomImages() {
        currentImageList = [...images].sort(() => 0.5 - Math.random());
        currentPage = 1;
        showImagesForPage(currentImageList);
    }
    
    function searchImages() {
        const q = searchBox.value.trim().toLowerCase();
        if(!q){ showRandomImages(); return; }
        currentImageList = images.filter(img => (img.title||'').toLowerCase().includes(q));
        currentPage = 1;
        showImagesForPage(currentImageList);
    }

    async function showImagesForPage(list) {
        gallery.innerHTML = '<div class="loader-container" style="display:flex;"><span class="loader"></span></div>';
        pagination.innerHTML = '';
        if(list.length === 0){ gallery.innerHTML = '<div class="error-message">No images found.</div>'; return; }

        const start = (currentPage - 1) * imagesPerPage;
        const pageImages = list.slice(start, start + imagesPerPage);
        
        const loadedImages = await Promise.all(pageImages.map(imgObj => new Promise(resolve => {
            const img = new Image();
            img.src = imgObj.url;
            img.onload = () => resolve({ ...imgObj, status: 'ok' });
            img.onerror = () => resolve({ ...imgObj, status: 'err' });
        })));
        
        gallery.innerHTML = '';
        const validImages = loadedImages.filter(res => res.status === 'ok');

        validImages.forEach((imgObj, idx) => {
            const card = document.createElement('div');
            card.className = 'image-card';
            const link = document.createElement('a');
            link.href = 'javascript:void(0)';
            link.onclick = (e) => { e.preventDefault(); openPopup(imgObj.url, imgObj.title, link); };
            const imgEl = document.createElement('img');
            imgEl.src = imgObj.url;
            imgEl.alt = imgObj.title || 'LovelyStock image';
            link.appendChild(imgEl);
            card.appendChild(link);
            gallery.appendChild(card);
            // Staggered animation
            setTimeout(() => card.classList.add('loaded'), idx * 30);
        });
        updatePagination(list);
    }
    
    function updatePagination(list) {
        // ... (Unchanged from V5)
        const totalPages = Math.ceil(list.length / imagesPerPage) || 1;
        if (totalPages <= 1) { pagination.innerHTML = ''; return; }
        pagination.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><button class="page-button" id="prevBtn">&lt; Back</button><div>Page ${currentPage} of ${totalPages}</div><button class="page-button" id="nextBtn">Forward &gt;</button></div>`;
        const prevBtn = document.getElementById('prevBtn'), nextBtn = document.getElementById('nextBtn');
        prevBtn.disabled = (currentPage===1);
        nextBtn.disabled = (currentPage===totalPages);
        prevBtn.onclick = ()=>{ if(currentPage>1){ currentPage--; showImagesForPage(currentImageList); } };
        nextBtn.onclick = ()=>{ if(currentPage<totalPages){ currentPage++; showImagesForPage(currentImageList); } };
    }

    // --- POPUP LOGIC WITH FLIP ANIMATION & MAC CONTROLS ---
    function openPopup(url, title, cardElement) {
        originRect = cardElement.getBoundingClientRect(); // Get origin for FLIP

        // 1. FIRST: Set initial state (at the card's position)
        const scaleX = originRect.width / window.innerWidth;
        const scaleY = originRect.height / window.innerHeight;
        const translateX = originRect.left - (window.innerWidth - originRect.width) / 2;
        const translateY = originRect.top - (window.innerHeight - originRect.height) / 2;
        
        popupContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
        popupContent.style.transition = 'none'; // No transition for the initial setup
        
        popupImage.src = url;
        popupTitle.textContent = title || 'Untitled Image';
        popupDesc.textContent = title || 'No description available.';
        
        popup.classList.add('open');

        // 2. LAST & PLAY: In the next frame, transition to the final state
        requestAnimationFrame(() => {
            popupContent.style.transition = 'transform .4s cubic-bezier(0.45, 0.05, 0.55, 0.95), opacity .3s ease';
            popupContent.style.transform = 'translate(0, 0) scale(1)';
        });

        // Setup download button
        document.getElementById('popupDownload').onclick = () => downloadImage(url, title);
    }

    function closePopup() {
        if (!originRect) { // Fallback for edge cases
            popup.classList.remove('open');
            return;
        }
        
        const scaleX = originRect.width / popupContent.offsetWidth;
        const scaleY = originRect.height / popupContent.offsetHeight;
        const translateX = originRect.left - popupContent.getBoundingClientRect().left;
        const translateY = originRect.top - popupContent.getBoundingClientRect().top;
        
        popupContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
        popup.classList.remove('open', 'fullscreen'); // Also remove fullscreen class

        popupContent.addEventListener('transitionend', () => {
            popupContent.style.transition = 'none'; // Clean up
        }, { once: true });
    }
    
    // MacBook Controls
    popup.querySelector('.dot-close').onclick = closePopup;
    popup.querySelector('.dot-min').onclick = closePopup;
    popup.querySelector('.dot-expand').onclick = () => popup.classList.add('fullscreen');
    
    const fsEscape = popup.querySelector('.fullscreen-escape');
    fsEscape.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
    fsEscape.onclick = () => popup.classList.remove('fullscreen');

    // --- Perfected Download Logic ---
    async function downloadImage(url, title) {
        const button = document.getElementById('popupDownload');
        const originalText = button.textContent;
        button.textContent = 'Preparing...';
        button.disabled = true;

        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            const tempLink = document.createElement('a');
            tempLink.href = blobUrl;
            // Sanitize filename: remove periods, truncate, add .jpg
            const sanitizedTitle = (title || 'lovelystock-image').replace(/\./g, '');
            tempLink.download = sanitizedTitle.slice(0, 150) + '.jpg';
            tempLink.click();
            URL.revokeObjectURL(blobUrl);
        } catch (error) {
            window.open(url, '_blank'); // Fallback
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }
    
    // --- Initial Load & Event Listeners ---
    searchBox.addEventListener('keypress', (e) => { if(e.key==='Enter') searchImages(); });
    logo.addEventListener('click', () => { searchBox.value=''; showRandomImages(); });
    window.addEventListener('load', loadCSV);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && popup.classList.contains('open')) {
            if (popup.classList.contains('fullscreen')) {
                popup.classList.remove('fullscreen');
            } else {
                closePopup();
            }
        }
    });

  </script>
</body>
</html>
