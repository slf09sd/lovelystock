<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LovelyStock — Spread the Love</title>
  <style>
    /* 
      --- V4: Heavy Glass & Liquid Effects ---
      - Increased blur and transparency for a "Heavy Glass" theme.
      - Added animated glass particles to the header.
      - Implemented a JS-powered ripple effect on image card hover.
      - Replaced the popup entrance animation with a liquid/gel wobble effect.
      - Added subtle text-shadows for better readability on the new glass theme.
    */
    :root{
      --bg: #f5f7fa;
      --bg-grad: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --text: #000;
      --text-muted: #4a5263; 
      --accent: #ef476f;
      --radius: 16px;
      --shadow: 0 4px 12px rgba(2,6,23,0.06);
      --shadow-lg: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
      --glass: rgba(255, 255, 255, 0.4);
      --glass-border: rgba(255, 255, 255, 0.18);
      --gap: 16px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      color-scheme: light;
    }

    .dark-mode {
      --bg: #111827;
      --bg-grad: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --glass: rgba(31, 41, 55, 0.35);
      --glass-border: rgba(255, 255, 255, 0.1);
      --shadow-lg: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      color-scheme: dark;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg-grad);color:var(--text);transition: background .3s ease, color .3s ease}

    .background-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden}
    .blob{position:absolute;border-radius:50%;background:rgba(239,71,111,0.15);filter:blur(120px);animation:move 25s infinite alternate}
    .blob:nth-child(2){background:rgba(6,214,160,0.15);animation-duration:30s;animation-delay:-5s}
    @keyframes move{from{transform:translate(-10vw,-10vh) scale(1)}to{transform:translate(20vw,30vh) scale(1.2)}}
    
    header{
      position:fixed; top:16px; left:16px; right:16px; max-width:980px; margin: 0 auto;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px; gap:12px;
      background: var(--glass); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border); border-radius: 999px; box-shadow: var(--shadow-lg);
      z-index:40; transition: transform .3s ease-out, background .3s ease, border .3s ease;
      overflow: hidden;
    }
    .logo{font-weight:700;font-size:20px;color:var(--accent);cursor:pointer; text-shadow: 0 1px 2px rgba(0,0,0,0.1);}
    
    /* Animated Glass Particles in Header */
    .header-particles{position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none}
    .header-particles span{position:absolute;border-radius:50%;background:rgba(255,255,255,0.2);animation:particle-float 20s linear infinite}
    .header-particles span:nth-child(1){width:5px;height:5px;left:10%;animation-delay:-1s;animation-duration:15s}
    .header-particles span:nth-child(2){width:8px;height:8px;left:30%;animation-delay:-5s;animation-duration:25s}
    .header-particles span:nth-child(3){width:4px;height:4px;left:50%;animation-delay:-10s;animation-duration:20s}
    .header-particles span:nth-child(4){width:6px;height:6px;left:70%;animation-delay:-15s;animation-duration:18s}
    @keyframes particle-float{from{transform:translateY(120%) translateX(-10px) scale(1);opacity:0}25%{opacity:1}75%{opacity:1}to{transform:translateY(-120%) translateX(10px) scale(0.5);opacity:0}}
    .dark-mode .header-particles span { background: rgba(255,255,255,0.1); }

    .search-bar{display:flex;gap:8px;align-items:center;flex:1;max-width:760px;margin-left:20px}
    .search-bar input{flex:1;padding:12px 14px;border-radius:999px;border:none;background:rgba(0,0,0,0.05);box-shadow:none;outline:none;font-size:14px;color:var(--text);transition:background .3s ease}
    .dark-mode .search-bar input{background:rgba(255,255,255,0.1)}
    .search-bar input::placeholder{color:var(--text-muted)}
    .search-bar button{background:var(--accent);border:none;padding:10px;width:38px;height:38px;border-radius:50%;color:white;cursor:pointer;display:grid;place-items:center}
    .theme-toggle{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:8px;border-radius:50%}
    .theme-toggle .icon-sun{display:none}
    .dark-mode .theme-toggle .icon-sun{display:block}
    .dark-mode .theme-toggle .icon-moon{display:none}

    main{padding:100px var(--gap) 20px;max-width:none;margin:0 auto}
    #imageGallery{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:var(--gap)}
    
    .image-card {
      position: relative; border-radius: var(--radius); overflow: hidden;
      display: block; aspect-ratio: 4/3; transform-origin: center;
      transition: transform .28s cubic-bezier(.2, .9, .2, 1), box-shadow .25s;
      box-shadow: var(--shadow);
      padding: 1px; background: var(--glass); z-index: 1;
    }
    .image-card::before {
      content: ''; position: absolute; inset: 0; z-index: -1;
      border-radius: inherit;
      background: conic-gradient(from 0deg, var(--accent), #ffcf59, #06d6a0, var(--accent));
      animation: rotate 4s linear infinite; opacity: 0; transition: opacity .4s ease;
    }
    .image-card:hover::before, .image-card:focus-within::before { opacity: 1; }
    @keyframes rotate { to { transform: rotate(360deg); } }
    .image-card img{width:100%;height:100%;object-fit:cover;display:block;border-radius:calc(var(--radius) - 1px);}
    .image-card:hover{transform:translateY(-8px) scale(1.03);box-shadow:var(--shadow-lg)}
    .image-card{opacity:0;transform:translateY(10px);animation:cardIn .42s forwards;}
    @keyframes cardIn{to{opacity:1;transform:none}}

    /* Ripple Effect on Hover */
    .ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,0.4);transform:scale(0);animation:ripple-effect .6s linear;pointer-events:none}
    @keyframes ripple-effect{to{transform:scale(4);opacity:0}}

    #pagination{display:flex;align-items:center;justify-content:center;padding:24px 10px;margin-top:16px;gap:12px}
    .pagination-info{color:var(--text-muted);font-size:14px;padding:8px 12px;background:var(--glass);border-radius:12px;border:1px solid var(--glass-border)}
    .page-button{background:var(--glass);border:1px solid var(--glass-border);padding:8px 12px;border-radius:10px;cursor:pointer;color:var(--text);transition:transform .2s}
    .page-button:hover:not(:disabled){transform:scale(1.05);box-shadow:var(--shadow)}

    /* Liquid-Gel Popup */
    .popup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,10,20,0.3);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:200;padding:28px}
    .popup.open{display:flex}
    .popup-content{
      max-width:960px;width:100%; background:var(--glass); backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
      border:1px solid var(--glass-border); border-radius:var(--radius); padding:18px;
      display:flex;gap:18px;align-items:flex-start; box-shadow:0 30px 80px rgba(2,6,23,0.35);
      animation:gelatinWobble .5s cubic-bezier(0.45, 0.05, 0.55, 0.95) forwards;
    }
    /* Liquid-Gel Wobble Animation */
    @keyframes gelatinWobble {
        0% { transform: scale(0.8); opacity: 0; }
        50% { transform: scale(1.05); }
        80% { transform: scale(0.98); }
        100% { transform: scale(1); opacity: 1; }
    }
    .popup-media img{width:100%;height:100%;object-fit:contain;background:rgba(0,0,0,0.1); border-radius: 12px;}
    .popup-title{font-weight:700;font-size:18px;margin:0; text-shadow: 0 1px 2px rgba(0,0,0,0.1);}
    
    @media (max-width:640px){
      .popup-content{flex-direction:column;max-height:92vh;overflow:auto}
      .popup-side{width:100%;max-width:none}
      #imageGallery{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    .error-message{padding:40px;text-align:center;color:var(--text-muted);grid-column:1/-1}
  </style>
</head>
<body>

  <div class="background-container">
    <div class="blob" style="top: -20%; left: -10%; width: 50vw; height: 50vw;"></div>
    <div class="blob" style="top: 30%; left: 60%; width: 40vw; height: 40vw;"></div>
  </div>

  <header>
    <div class="header-particles"><span></span><span></span><span></span><span></span></div>
    <div class="logo" id="logo">LovelyStock</div>
    <div class="search-bar" role="search">
      <input id="searchBox" type="text" placeholder="Search lovely images..." aria-label="Search images">
      <button id="searchBtn" aria-label="Search">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
      </button>
    </div>
    <div class="header-actions">
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
      </button>
    </div>
  </header>

  <main>
    <div id="imageGallery" aria-live="polite" aria-atomic="true"></div>
    <div id="pagination"></div>
  </main>

  <div id="imagePopup" class="popup" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="popup-content" role="document">
      <div class="popup-media">
        <img id="popupImage" src="" alt="">
      </div>
      <div class="popup-side">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h3 id="popupTitle" class="popup-title">Title</h3>
          <button id="closePopupBtn" class="close-btn" aria-label="Close popup">✕</button>
        </div>
        <div id="popupDesc" class="popup-desc">Description</div>
        <div style="margin-top:auto;display:flex;gap:10px;align-items:center;padding-top:10px">
          <a id="popupDownload" class="download-button" href="#" download>Download</a>
          <button id="popupOpenTab" class="page-button">Open in new tab</button>
        </div>
      </div>
    </div>
  </div>

  <footer style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">© 2024 LovelyStock</footer>

  <script>
    // === V4 SCRIPT: HEAVY GLASS & INTERACTIVITY ===
    
    // --- Dark Mode Toggler ---
    const themeToggle = document.getElementById('themeToggle');
    const docElement = document.documentElement;
    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    docElement.classList.toggle('dark-mode', savedTheme === 'dark');
    themeToggle.addEventListener('click', () => {
      docElement.classList.toggle('dark-mode');
      localStorage.setItem('theme', docElement.classList.contains('dark-mode') ? 'dark' : 'light');
    });

    // --- Parallax Header ---
    const header = document.querySelector('header');
    let ticking = false;
    function handleScroll() {
        let scrollTop = window.scrollY;
        if (scrollTop > 50) {
            const parallaxTranslate = scrollTop * 0.4;
            const scale = Math.max(0.95, 1 - scrollTop / 2000);
            header.style.transform = `translateY(-${parallaxTranslate}px) scale(${scale})`;
        } else {
            header.style.transform = 'translateY(0) scale(1)';
        }
    }
    window.addEventListener('scroll', () => {
        if (!ticking) { window.requestAnimationFrame(() => { handleScroll(); ticking = false; }); ticking = true; }
    });

    // --- Ripple Hover Effect on Images ---
    const gallery = document.getElementById('imageGallery');
    gallery.addEventListener('mouseenter', (event) => {
        const card = event.target.closest('.image-card');
        if (!card) return;

        const rect = card.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        const ripple = document.createElement('span');
        ripple.className = 'ripple';
        const size = Math.max(card.clientWidth, card.clientHeight);
        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x - size / 2}px`;
        ripple.style.top = `${y - size / 2}px`;

        card.appendChild(ripple);

        setTimeout(() => { ripple.remove(); }, 600);
    }, true);


    // --- CORE GALLERY LOGIC (Unchanged) ---
    let images = [];
    let currentPage = 1;
    const imagesPerPage = 100;
    let currentImageList = [];

    const CSV_URL = 'https://slf09sd.github.io/lovelystock/images.csv';
    const fallbackDataURI = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="20">Image not available</text></svg>');

    async function loadCSV(){
      try{
        const r = await fetch(CSV_URL, {cache:'no-cache'});
        if(!r.ok) throw new Error('CSV fetch failed: '+r.status);
        const text = await r.text();
        if(!text || !text.trim()) throw new Error('CSV empty');
        images = parseCSV(text);
        if(images.length===0) throw new Error('No valid images in CSV');
        showRandomImages();
      }catch(err){
        console.error(err);
        document.getElementById('imageGallery').innerHTML = '<div class="error-message">Failed to load images.</div>';
      }
    }

    function parseCSV(data){
      const lines = data.split('\n').map(l=>l.trim()).filter(l=>l);
      if(lines.length<=1) return [];
      const result = [];
      for(let i=1;i<lines.length;i++){
        const cols = smartSplit(lines[i]);
        if(cols.length>=1){
          const url = cols[0].trim();
          const title = cols.slice(1).join(',').trim() || '';
          if(url && (url.startsWith('http://')||url.startsWith('https://'))){
            result.push({url, title});
          }
        }
      }
      return result;
    }

    function smartSplit(row){
      const items=[];let cur='';let inQ=false;
      for(let i=0;i<row.length;i++){const ch=row[i];if(ch==='"'){inQ=!inQ;continue;}if(ch===',' && !inQ){items.push(cur);cur='';}else{cur+=ch;}}
      items.push(cur);
      return items.map(s=>s.trim());
    }

    function showRandomImages(){
      currentImageList = [...images].sort(()=>Math.random()-0.5).slice(0, imagesPerPage);
      currentPage = 1;
      showImages(currentImageList);
    }

    function searchImages(){
      const q = document.getElementById('searchBox').value.trim().toLowerCase();
      if(!q){ showRandomImages(); return; }
      const filtered = images.filter(img => (img.title||'').toLowerCase().includes(q));
      currentImageList = filtered;
      currentPage = 1;
      showImages(currentImageList);
    }

    function showImages(list){
      gallery.innerHTML='';
      const pagination = document.getElementById('pagination');
      if(list.length===0){ gallery.innerHTML='<div class="error-message">No images found.</div>'; pagination.innerHTML=''; return; }
      const start = (currentPage-1)*imagesPerPage;
      const pageImages = list.slice(start, start+imagesPerPage);
      pageImages.forEach((imgObj, idx)=>{
        const card = document.createElement('a');
        card.href = 'javascript:void(0)';
        card.className='image-card';
        card.style.animationDelay = `${idx * 0.03}s`;
        card.onclick = (e) => { e.preventDefault(); openPopup(imgObj.url, imgObj.title); };
        card.onkeydown = (e) => { if(e.key==='Enter') { e.preventDefault(); openPopup(imgObj.url, imgObj.title); } };
        const img = document.createElement('img');
        img.loading='lazy';
        img.decoding='async';
        img.src = imgObj.url;
        img.alt = imgObj.title || 'LovelyStock image';
        img.addEventListener('error', ()=>{ img.src = fallbackDataURI; });
        card.appendChild(img);
        gallery.appendChild(card);
      });
      updatePagination(list);
    }

    function updatePagination(list){
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(list.length / imagesPerPage) || 1;
      if (totalPages <= 1) { pagination.innerHTML = ''; return; }
      pagination.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><button class="page-button" id="prevBtn">&lt; Back</button><div class="pagination-info">Page ${currentPage} of ${totalPages}</div><button class="page-button" id="nextBtn">Forward &gt;</button></div>`;
      const prevBtn = document.getElementById('prevBtn'), nextBtn = document.getElementById('nextBtn');
      prevBtn.disabled = (currentPage===1);
      nextBtn.disabled = (currentPage===totalPages);
      prevBtn.onclick = ()=>{ if(currentPage>1){ currentPage--; showImages(currentImageList); } };
      nextBtn.onclick = ()=>{ if(currentPage<totalPages){ currentPage++; showImages(currentImageList); } };
    }

    const popup = document.getElementById('imagePopup');
    const popupImage = document.getElementById('popupImage');
    const popupTitle = document.getElementById('popupTitle');
    const popupDesc = document.getElementById('popupDesc');
    const closePopupBtn = document.getElementById('closePopupBtn');

    function openPopup(url, title){
      popupImage.src = url;
      popupImage.alt = title || 'LovelyStock image';
      popupTitle.textContent = title || 'Untitled image';
      popupDesc.textContent = title || 'No description available.';
      const filename = (title && title.replace(/[^a-z0-9\.\- _]/gi,'').slice(0,60)) || url.split('/').pop() || 'image.jpg';
      document.getElementById('popupDownload').href = url;
      document.getElementById('popupDownload').download = filename;
      document.getElementById('popupOpenTab').onclick = ()=> window.open(url, '_blank');
      popup.classList.add('open');
      document.body.style.overflow='hidden';
      closePopupBtn.focus();
    }
    function closePopup(){
      popup.classList.remove('open');
      document.body.style.overflow='auto';
      popupImage.src = '';
    }
    popup.addEventListener('click', (e)=>{ if(e.target===popup) closePopup(); });
    closePopupBtn.addEventListener('click', closePopup);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && popup.classList.contains('open')) closePopup(); });

    document.getElementById('searchBtn').addEventListener('click', searchImages);
    document.getElementById('searchBox').addEventListener('keypress', (e)=>{ if(e.key==='Enter') searchImages(); });
    document.getElementById('logo').addEventListener('click', ()=>{ document.getElementById('searchBox').value=''; showRandomImages(); });
    window.addEventListener('load', loadCSV);
  </script>
</body>
</html>
