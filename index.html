<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LovelyStock — Spread the Love</title>
  <style>
    /* 
      --- V8: The Liquid Glass Update ---
      - NEW: Popup controls are now larger & colored like macOS.
      - NEW: Popup now closes when clicking on the outside overlay.
      - NEW: Pagination controls now have a liquid glass effect.
      - IMPROVED: "No images found" message is now styled with the glass effect.
      - IMPROVED: Tweaked transitions for an even smoother feel.
    */
    :root{
      --bg-grad: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --text: #000;
      --text-muted: #4a5263; 
      --accent: #ef476f;
      --radius: 16px;
      --shadow-lg: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
      --glass: rgba(255, 255, 255, 0.5);
      --glass-border: rgba(255, 255, 255, 0.2);
      --gap: 16px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      color-scheme: light;
    }

    .dark-mode {
      --bg-grad: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --glass: rgba(31, 41, 55, 0.45);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg-grad);color:var(--text);transition:background .3s ease}
    html{scrollbar-width:none} html::-webkit-scrollbar{display:none}

    .custom-scrollbar-thumb{position:fixed;top:0;right:2px;width:6px;background:var(--accent);border-radius:3px;z-index:1000;opacity:0;transition:opacity .3s ease, background .3s ease;pointer-events:none}
    .is-scrolling .custom-scrollbar-thumb{opacity:0.7}

    /* --- Liquid Search Header --- */
    header{position:fixed;top:16px;left:16px;right:16px;max-width:980px;margin:0 auto;display:flex;align-items:center;padding:10px 12px;gap:12px;background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-border);border-radius:999px;box-shadow:var(--shadow-lg);z-index:40;transition:all .4s cubic-bezier(0.45,0.05,0.55,0.95)}
    .logo{font-weight:700;font-size:20px;color:var(--accent);cursor:pointer;white-space:nowrap;transition:width .4s cubic-bezier(0.45,0.05,0.55,0.95),opacity .4s ease;overflow:hidden}
    .search-bar{display:flex;flex:1;gap:8px;align-items:center;transition:all .4s cubic-bezier(0.45,0.05,0.55,0.95)}
    .search-bar input{flex:1;padding:10px 14px;border-radius:999px;border:none;background:rgba(0,0,0,0.05);box-shadow:none;outline:none;font-size:14px;color:var(--text);transition:background .3s ease}
    .dark-mode .search-bar input{background:rgba(255,255,255,0.1)}
    .search-bar input::placeholder{color:var(--text-muted)}

    .header-actions{transition:opacity .4s ease,transform .4s ease}
    .theme-toggle{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:8px;border-radius:50%;display:grid;place-items:center;transition:color .2s ease}
    .theme-toggle:hover{color:var(--text)}

    header.search-focused{gap:0;padding-left:20px;padding-right:20px}
    header.search-focused .logo{width:35px}
    header.search-focused .header-actions{opacity:0;transform:translateX(20px);pointer-events:none}

    main{padding:100px var(--gap) 20px;max-width:1600px;margin:0 auto}
    #imageGallery{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:var(--gap);transition:opacity .4s ease; min-height:50vh}

    .loader-container{display:none;justify-content:center;align-items:center;padding:80px;grid-column:1/-1}
    .loader{width:48px;height:48px;border:5px solid;border-color:var(--accent) transparent;border-radius:50%;display:inline-block;animation:rotation 1s linear infinite}
    @keyframes rotation{to{transform:rotate(360deg)}}
    
    .error-message{grid-column:1/-1;text-align:center;padding:40px 20px;background:var(--glass);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:var(--radius);color:var(--text-muted)}

    .image-card{visibility:hidden}
    .image-card.loaded{visibility:visible;opacity:0;transform:translateY(10px);animation:cardIn .42s forwards;}
    @keyframes cardIn{to{opacity:1;transform:none}}
    .image-card a{position:relative;display:block;aspect-ratio:4/3;box-shadow:var(--shadow);padding:1px;background:var(--glass);z-index:1;border-radius:var(--radius);overflow:hidden;transition:transform .28s cubic-bezier(.2,.9,.2,1),box-shadow .25s}
    .image-card a:hover{transform:translateY(-8px) scale(1.03);box-shadow:var(--shadow-lg)}
    .image-card img{width:100%;height:100%;object-fit:cover;display:block;border-radius:calc(var(--radius) - 1px)}

    /* --- Emergent Popup --- */
    .popup{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:200;padding:28px;background:rgba(10,10,20,0.3);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);opacity:0;visibility:hidden;transition:opacity .4s ease, visibility 0s .4s}
    .popup.open{opacity:1;visibility:visible;transition-delay:0s}
    .popup-content{max-width:960px;width:100%;background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-border);border-radius:var(--radius);box-shadow:0 30px 80px rgba(2,6,23,0.35);display:flex;gap:18px;align-items:flex-start;padding:12px;transition:transform .4s cubic-bezier(0.45,0.05,0.55,0.95),opacity .3s ease,width .4s ease,height .4s ease,max-width .4s ease;will-change:transform;position:relative}
    .popup-media img{width:100%;height:100%;object-fit:contain;background:rgba(0,0,0,0.1);border-radius:10px;max-height:80vh}
    
    .popup-side{display:flex;flex-direction:column;gap:12px;width:320px;flex-shrink:0;transition:opacity .3s ease;padding-top:24px}
    
    .popup-desc{color:var(--text-muted);font-size:14px;line-height:1.5;overflow-y:auto;max-height:150px;padding-right:8px;word-wrap:break-word}
    .popup-desc::-webkit-scrollbar{width:6px}
    .popup-desc::-webkit-scrollbar-track{background:rgba(0,0,0,0.05);border-radius:3px}
    .popup-desc::-webkit-scrollbar-thumb{background:var(--accent);opacity:0.7;border-radius:3px}

    /* --- NEW: macOS style window controls --- */
    .window-controls{position:absolute;top:12px;right:12px;display:flex;gap:8px;z-index:5}
    .window-dot{width:14px;height:14px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:filter .2s ease;border:0.5px solid rgba(0,0,0,0.1)}
    .dark-mode .window-dot{border:none}
    .window-dot svg{width:8px;height:8px;stroke-width:1.5;color:rgba(0,0,0,0.6);opacity:0;transition:opacity .2s ease}
    .popup-content:hover .window-dot svg{opacity:1}
    
    .dot-close{background-color:#ff5f56;}
    .dot-min{background-color:#ffbd2e;}
    .dot-expand{background-color:#27c93f;}
    .window-dot:hover{filter:brightness(1.1)}
    
    .fullscreen-escape{position:absolute;top:16px;right:16px;opacity:0;visibility:hidden;transition:all .3s ease;z-index:10;background:var(--glass);border:1px solid var(--glass-border);color:var(--text);border-radius:50%;width:32px;height:32px;cursor:pointer}
    .popup.fullscreen .fullscreen-escape{opacity:1;visibility:visible}

    /* Fullscreen mode (perfectly centered) */
    .popup.fullscreen .popup-content{width:100%;height:100%;max-width:100vw;padding:0;border-radius:0;display:grid;place-items:center}
    .popup.fullscreen .popup-side{opacity:0;pointer-events:none}
    .popup.fullscreen .window-controls{opacity:0;pointer-events:none}
    
    .download-button{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;text-decoration:none;font-weight:600;text-align:center;transition:transform .2s,box-shadow .2s,background .2s;border:none;cursor:pointer}
    .download-button:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(239,71,111,0.3)}
    .download-button:disabled{background:var(--text-muted);cursor:not-allowed;transform:none;box-shadow:none}
    
    /* --- NEW: Liquid Glass Pagination --- */
    #pagination{display:flex;justify-content:center;align-items:center;padding:40px 0 20px;gap:10px}
    .page-button, .page-status{padding:10px 18px;background:var(--glass);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:12px;font-size:14px;color:var(--text);transition:transform .2s ease, background .2s ease}
    .page-button{cursor:pointer}
    .page-button:hover:not(:disabled){transform:scale(1.05);background:rgba(255,255,255,0.7)}
    .dark-mode .page-button:hover:not(:disabled){background:rgba(31, 41, 55, 0.7)}
    .page-button:disabled{opacity:0.5;cursor:not-allowed}
  </style>
</head>
<body>

  <div class="background-container"><div class="blob"></div></div>
  <div class="custom-scrollbar-thumb"></div>

  <header>
    <div class="logo" id="logo"><span class="logo-text">LovelyStock</span></div>
    <div class="search-bar" role="search">
      <input id="searchBox" type="text" placeholder="Search lovely images..." aria-label="Search images">
    </div>
    <div class="header-actions">
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme"></button>
    </div>
  </header>

  <main>
    <div id="imageGallery"><div class="loader-container"><span class="loader"></span></div></div>
    <div id="pagination"></div>
  </main>

  <div id="imagePopup" class="popup" role="dialog" aria-modal="true">
    <div class="popup-content" role="document">
        <div class="window-controls">
            <!-- Updated window controls -->
            <span class="window-dot dot-close" aria-label="Close"><svg viewBox="0 0 8 8"><line x1="1" y1="1" x2="7" y2="7"></line><line x1="7" y1="1" x2="1" y2="7"></line></svg></span>
            <span class="window-dot dot-min" aria-label="Minimize"><svg viewBox="0 0 8 8"><line x1="1" y1="4" x2="7" y2="4"></line></svg></span>
            <span class="window-dot dot-expand" aria-label="Expand"><svg viewBox="0 0 8 8" stroke="currentColor" fill="none"><path d="M3 1H1V3"></path><path d="M5 7H7V5"></path><path d="M7 3L5 5"></path><path d="M1 5L3 7"></path></svg></span>
        </div>
        <button class="fullscreen-escape" aria-label="Exit fullscreen"></button>
      <div class="popup-media"><img id="popupImage" src="" alt=""></div>
      <div class="popup-side">
        <div id="popupDesc" class="popup-desc"></div>
        <div class="download-actions" style="margin-top:auto;padding-top:10px">
          <button id="popupDownload" class="download-button">Download</button>
        </div>
      </div>
    </div>
  </div>

  <footer style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">© 2024 LovelyStock</footer>

  <script>
    // === V8 SCRIPT: THE LIQUID GLASS UPDATE ===

    // --- Dynamic Elements ---
    const header = document.querySelector('header');
    const logo = document.getElementById('logo');
    const searchBox = document.getElementById('searchBox');
    const gallery = document.getElementById('imageGallery');
    const pagination = document.getElementById('pagination');
    const popup = document.getElementById('imagePopup');
    const popupContent = popup.querySelector('.popup-content');
    const popupImage = document.getElementById('popupImage');
    const popupDesc = document.getElementById('popupDesc');
    let originRect = null; // For FLIP animation

    // --- Liquid Search Header Logic ---
    function setSearchFocus(isFocused) {
        header.classList.toggle('search-focused', isFocused);
        logo.querySelector('.logo-text').textContent = isFocused ? 'LS' : 'LovelyStock';
    }
    searchBox.addEventListener('focus', () => setSearchFocus(true));
    searchBox.addEventListener('blur', () => setSearchFocus(false));
    document.addEventListener('scroll', () => {
        if(header.classList.contains('search-focused') && window.scrollY > 50) {
            searchBox.blur();
        }
    });

    // --- Dark Mode & Theme Toggle Setup ---
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.innerHTML = `<svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg><svg class="icon-sun" style="display:none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
    const iconMoon = themeToggle.querySelector('.icon-moon');
    const iconSun = themeToggle.querySelector('.icon-sun');
    function applyTheme(theme) {
        document.documentElement.classList.toggle('dark-mode', theme === 'dark');
        iconMoon.style.display = theme === 'dark' ? 'none' : 'block';
        iconSun.style.display = theme === 'dark' ? 'block' : 'none';
    }
    let currentTheme = localStorage.getItem('theme') || 'light';
    applyTheme(currentTheme);
    themeToggle.addEventListener('click', () => {
        currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
        localStorage.setItem('theme', currentTheme);
        applyTheme(currentTheme);
    });

    // --- Custom Scrollbar ---
    const body = document.body;
    let scrollTimeout;
    window.addEventListener('scroll', () => {
        body.classList.add('is-scrolling');
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => body.classList.remove('is-scrolling'), 1500);
        const progress = window.scrollY / (body.scrollHeight - window.innerHeight);
        const thumbHeight = Math.max(30, window.innerHeight * 0.2);
        document.querySelector('.custom-scrollbar-thumb').style.height = `${thumbHeight}px`;
        document.querySelector('.custom-scrollbar-thumb').style.top = `${progress * (window.innerHeight - thumbHeight)}px`;
    });

    // --- CORE GALLERY LOGIC (with preloader) ---
    let images = [], currentPage = 1, currentImageList = [];
    const imagesPerPage = 100;
    const CSV_URL = 'https://slf09sd.github.io/lovelystock/images.csv';

    async function loadCSV() {
        try{
            const r = await fetch(CSV_URL, {cache:'no-cache'});
            if(!r.ok) throw new Error('CSV fetch failed');
            const text = await r.text();
            if(!text || !text.trim()) throw new Error('CSV empty');
            images = text.split('\n').map(l=>l.trim()).filter(l=>l).slice(1).map(line => {
                const parts = line.split(',');
                const url = parts.shift().trim();
                const title = parts.join(',').replace(/"/g, '').trim();
                return { url, title };
            }).filter(img => img.url.startsWith('http'));
            showRandomImages();
        } catch(err){
            gallery.innerHTML = '<div class="error-message">Failed to load images. Please check your connection and try again.</div>';
        }
    }

    function showRandomImages() {
        currentImageList = [...images].sort(() => 0.5 - Math.random());
        currentPage = 1;
        showImagesForPage(currentImageList);
    }
    
    function searchImages() {
        const q = searchBox.value.trim().toLowerCase();
        if(!q){ showRandomImages(); return; }
        currentImageList = images.filter(img => (img.title||'').toLowerCase().includes(q));
        currentPage = 1;
        showImagesForPage(currentImageList);
    }

    async function showImagesForPage(list) {
        gallery.innerHTML = '<div class="loader-container" style="display:flex;"><span class="loader"></span></div>';
        pagination.innerHTML = '';
        if(list.length === 0){ gallery.innerHTML = '<div class="error-message">No images found for your search.</div>'; return; }

        const start = (currentPage - 1) * imagesPerPage;
        const pageImages = list.slice(start, start + imagesPerPage);
        
        const loadedImages = await Promise.all(pageImages.map(imgObj => new Promise(resolve => {
            const img = new Image();
            img.src = imgObj.url;
            img.onload = () => resolve({ ...imgObj, status: 'ok' });
            img.onerror = () => resolve({ ...imgObj, status: 'err' });
        })));
        
        gallery.innerHTML = '';
        const validImages = loadedImages.filter(res => res.status === 'ok');

        validImages.forEach((imgObj, idx) => {
            const card = document.createElement('div');
            card.className = 'image-card';
            const link = document.createElement('a');
            link.href = 'javascript:void(0)';
            link.onclick = (e) => { e.preventDefault(); openPopup(imgObj.url, imgObj.title, link); };
            const imgEl = document.createElement('img');
            imgEl.src = imgObj.url;
            imgEl.alt = imgObj.title || 'LovelyStock image';
            link.appendChild(imgEl);
            card.appendChild(link);
            gallery.appendChild(card);
            setTimeout(() => card.classList.add('loaded'), idx * 30);
        });
        updatePagination(list);
    }
    
    function updatePagination(list) {
        const totalPages = Math.ceil(list.length / imagesPerPage) || 1;
        if (totalPages <= 1) { pagination.innerHTML = ''; return; }
        // NEW: Updated pagination HTML with classes for glass styling
        pagination.innerHTML = `<button class="page-button" id="prevBtn">&lt; Back</button><div class="page-status">Page ${currentPage} of ${totalPages}</div><button class="page-button" id="nextBtn">Forward &gt;</button>`;
        const prevBtn = document.getElementById('prevBtn'), nextBtn = document.getElementById('nextBtn');
        prevBtn.disabled = (currentPage===1);
        nextBtn.disabled = (currentPage===totalPages);
        prevBtn.onclick = ()=>{ if(currentPage>1){ currentPage--; showImagesForPage(currentImageList); window.scrollTo(0,0); } };
        nextBtn.onclick = ()=>{ if(currentPage<totalPages){ currentPage++; showImagesForPage(currentImageList); window.scrollTo(0,0); } };
    }

    // --- POPUP LOGIC ---
    function openPopup(url, title, cardElement) {
        originRect = cardElement.getBoundingClientRect(); 

        const scaleX = originRect.width / window.innerWidth;
        const scaleY = originRect.height / window.innerHeight;
        const translateX = originRect.left + originRect.width / 2 - window.innerWidth / 2;
        const translateY = originRect.top + originRect.height / 2 - window.innerHeight / 2;
        
        popupContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
        popupContent.style.transition = 'none'; 
        
        popupImage.src = url;
        popupDesc.textContent = title || 'No description available.';
        
        popup.classList.add('open');

        requestAnimationFrame(() => {
            popupContent.style.transition = 'transform .4s cubic-bezier(0.45, 0.05, 0.55, 0.95), opacity .3s ease';
            popupContent.style.transform = 'translate(0, 0) scale(1)';
        });

        document.getElementById('popupDownload').onclick = () => downloadImage(url, title);
    }

    function closePopup() {
        if (!originRect || !popup.classList.contains('open')) return;
        
        const scaleX = originRect.width / popupContent.offsetWidth;
        const scaleY = originRect.height / popupContent.offsetHeight;
        const translateX = originRect.left + originRect.width / 2 - (popupContent.offsetLeft + popupContent.offsetWidth / 2);
        const translateY = originRect.top + originRect.height / 2 - (popupContent.offsetTop + popupContent.offsetHeight / 2);
        
        popupContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
        popup.classList.remove('open', 'fullscreen');

        popupContent.addEventListener('transitionend', () => {
            popupContent.style.transition = 'none';
        }, { once: true });
    }
    
    // Window Controls
    popup.querySelector('.dot-close').onclick = closePopup;
    popup.querySelector('.dot-min').onclick = closePopup; // Minimize now also closes it, as there's no minimize state
    popup.querySelector('.dot-expand').onclick = () => popup.classList.toggle('fullscreen');
    
    // NEW: Close popup when clicking the overlay
    popup.addEventListener('click', (e) => {
        if (e.target === popup) {
            closePopup();
        }
    });

    const fsEscape = popup.querySelector('.fullscreen-escape');
    fsEscape.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
    fsEscape.onclick = () => popup.classList.remove('fullscreen');

    // --- Perfected Download Logic ---
    async function downloadImage(url, title) {
        const button = document.getElementById('popupDownload');
        button.textContent = 'Preparing...';
        button.disabled = true;
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            const sanitizedTitle = (title || 'lovelystock-image').replace(/[^\w\s-]/g, '').trim();
            link.download = sanitizedTitle.slice(0, 150) + '.jpg';
            link.click();
            URL.revokeObjectURL(blobUrl);
        } catch (error) {
            window.open(url, '_blank');
        } finally {
            button.textContent = 'Download';
            button.disabled = false;
        }
    }
    
    // --- Initial Load & Event Listeners ---
    searchBox.addEventListener('keypress', (e) => { if(e.key==='Enter') searchImages(); });
    logo.addEventListener('click', () => { searchBox.value=''; showRandomImages(); });
    window.addEventListener('load', loadCSV);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && popup.classList.contains('open')) {
            popup.classList.contains('fullscreen') ? popup.classList.remove('fullscreen') : closePopup();
        }
    });
  </script>
</body>
</html>
